syntax = "proto3";

/*
  Compile by running (in the "client" directory of the repo):

  python -m grpc_tools.protoc -I . --python_out=. --grpc_python_out=. polyester/proto/api.proto --experimental_allow_proto3_optional
*/

package modal.client;

import "google/protobuf/any.proto";

message Empty {

}

message ContainerArguments{  // This is used to pass data from the worker to the container
  string task_id = 1;
  string function_id = 2;
  string input_buffer_id = 3;
  string session_id = 4;
  Function function_def = 7;
}

message GenericResult {  // Used for both tasks and function outputs
  enum Status {UNKNOWN = 0; SUCCESS = 1; FAILURE = 2;}
  Status status = 1;
  string exception = 2;
  int32 exitcode = 3;
  string traceback = 4;
  bytes data = 5;

  enum GeneratorStatus {NOT_GENERATOR = 0; INCOMPLETE = 1; COMPLETE = 2;}
  GeneratorStatus gen_status = 7;

  string input_id = 8;
}

message BufferItem {
  google.protobuf.Any data = 1;
  bool EOF = 2;
  string item_id = 3; // Each element is given an ID by the server.
  int32 idx = 4;
}

message BufferWriteRequest {
  string buffer_id = 1;
  repeated BufferItem items = 5;
  string idempotency_key = 4;
}

message BufferWriteResponse {
  enum BufferWriteStatus {UNKNOWN = 0; SUCCESS = 1; BUFFER_FULL = 2;}
  BufferWriteStatus status = 1;
}

message BufferReadRequest {
  string buffer_id = 1;
  int32 max_values = 2;
  float timeout = 3;
}

message BufferReadResponse {
  enum BufferReadStatus {UNKNOWN = 0; SUCCESS = 1; TIMEOUT = 2;}
  BufferReadStatus status = 2;
  repeated BufferItem items = 3;
}

enum ClientType {
  CT_UNKNOWN = 0;
  CT_CLIENT = 1;
  CT_WORKER = 2;
  CT_CONTAINER = 3;
  CT_SERVER = 4;
}

message ClientCreateRequest {
  ClientType client_type = 1;
  string version = 2;
}

message ClientCreateResponse {
  string client_id = 1;
  string error = 2;
}

message ClientHeartbeatRequest {
  string client_id = 1;
}

enum SessionState {
  SS_UNKNOWN = 0;
  SS_EPHEMERAL = 1;    // Will be discharged when the client disconnects
  SS_DETACHED = 2;   // Will be discharged when there's no more functions
  SS_DEPLOYED = 3;     // Will be discharged when overwritten
  SS_DRAINING = 4;     // Will be stopped once there are no dependencies
  SS_STOPPED = 5;      // Stopped
}

message SessionCreateRequest {
  string client_id = 1;
  string name = 2;    // Human readable label for the website
}

message SessionCreateResponse {
  string session_id = 1;
}

message SessionClientDisconnectRequest {
  string session_id = 1;
}

message SessionGetLogsRequest {
  string session_id = 1;
  float timeout = 2;
  bool draining = 3;
  string last_entry_id = 4;
}

message SessionSetObjectsRequest {
  // TODO: this is a bit of a hacky request meant to be somewhat temporary
  // At some point, every object should be assigned to a session/namespace when created,
  // so this method won't be necessary.
  string session_id = 1;
  map<string, string> object_ids = 2;
}

message SessionGetObjectsRequest {
  string session_id = 1;
  string task_id = 2;
}

message SessionGetObjectsResponse {
  map<string, string> object_ids = 1;
}

enum ShareNamespace {  // TODO: rename this to something else?
  SN_NONE = 0;  // Reserve this in order to force this to be set
  SN_ACCOUNT = 1;
  SN_ORGANIZATION = 2; // Not used at this point
  SN_GLOBAL = 3;
}

message SessionDeployRequest {
  string session_id = 1;
  ShareNamespace namespace = 2;
  string name = 3;
  string object_id = 4;
  map<string, string> object_ids = 5;
}

message SessionIncludeObjectRequest {
  string session_id = 1;
  ShareNamespace namespace = 2;
  string name = 3;
  string object_label = 4;
}

message SessionIncludeObjectResponse {
  string object_id = 1;
}

message SessionDetachRequest {
  string session_id = 1;
}

enum TaskState {
  TS_CREATED = 0;
  TS_QUEUED = 1;
  TS_WORKER_ASSIGNED = 2;
  TS_LOADING_IMAGE = 3;
  TS_RUNNING = 4;
  TS_COMPLETED = 5;
}

message TaskLogs {
  bytes data = 1;
  string fd = 2;
  string task_id = 3;
  TaskState task_state = 6;
  double timestamp = 7;
}

message TaskLogsBatch {
  string task_id = 1;
  repeated TaskLogs items = 2;
  repeated TaskLogs state_updates = 4;
  string entry_id = 5;
  int64 n_running = 6;
  bool task_done = 7;
  bool session_done = 8;
}

message QueueCreateRequest {
  string session_id = 1;
}

message QueueCreateResponse {
  string queue_id = 1;
}

message QueueGetRequest {
  string queue_id = 1;
  bool block = 2;
  float timeout = 3;
  int32 n_values = 4;
  string idempotency_key = 5;
}

message QueueGetResponse {
  repeated bytes values = 2;
}

message QueuePutRequest {
  string queue_id = 1;
  string idempotency_key = 3;
  repeated bytes values = 4;
}

message BaseImage {
  string image_id = 1;
  string docker_tag = 2;
}

message ImageContextFile {
  string filename = 1;
  bytes data = 2;
}

message Image {
  repeated BaseImage base_images = 5;
  repeated string dockerfile_commands = 6;
  repeated ImageContextFile context_files = 7;
  string local_image_python_executable = 10;
  string version = 11;
}

message ImageGetOrCreateRequest {
  Image image = 2;
  string session_id = 4;
}

message ImageGetOrCreateResponse {
  string image_id = 1;
}

message ImageJoinRequest {
  string image_id = 1;
  float timeout = 2;
  string session_id = 3;
}

message ImageJoinResponse {
  GenericResult result = 1;
}

message DictEntry {
  bytes key = 1;
  bytes value = 2;
}

message DictCreateRequest {
  repeated DictEntry data = 1;
  string session_id = 2;
}

message DictCreateResponse {
  string dict_id = 1;
}

message DictGetRequest {
  string dict_id = 1;
  bytes key = 2;
}

message DictGetResponse {
  bool found = 1 ;
  optional bytes value = 2;
}

message DictContainsRequest {
  string dict_id = 1;
  bytes key = 2;
}

message DictContainsResponse {
  bool found = 1;
}

message DictLenRequest {
  string dict_id = 1;
}

message DictLenResponse {
  int32 len = 1;
}

message DictUpdateRequest {
  string dict_id = 1;
  repeated DictEntry updates = 2;
}

message DictUpdateResponse {
}

message DictPopRequest {
  string dict_id = 1;
  bytes key = 2;
}

message DictPopResponse {
  bool found = 1 ;
  optional bytes value = 2;
}

message EnvDictCreateRequest {
  map<string, string> env_dict = 1;
  string session_id = 2;
}

message EnvDictCreateResponse {
  string env_dict_id = 1;
}

message Resources {
  bool gpu = 1;
}

message Function {
  string module_name = 1;
  string function_name = 2;
  repeated string mount_ids = 3;
  string image_id = 4;
  string env_dict_id = 5;
  bytes function_serialized = 6;

  enum DefinitionType {FILE = 0; SERIALIZED = 1;}
  DefinitionType definition_type = 7;

  enum FunctionType {FUNCTION = 0; GENERATOR = 1;}
  FunctionType function_type = 8;

  Resources resources = 9;
}

message FunctionCreateRequest {
  Function function = 1;
  string session_id = 2;
  string schedule_id = 3;
}

message FunctionCreateResponse {
  string function_id = 1;
}

message FunctionGetSerializedRequest {
  string function_id = 1;
}

message FunctionGetSerializedResponse {
  bytes function_serialized = 1;
}

message FunctionMapRequest {
  string function_id = 1;
}

message FunctionMapResponse {
  string input_buffer_id = 1;
  string output_buffer_id = 2;
}

message FunctionCallRequest {
  string function_id = 1;
  BufferWriteRequest buffer_req = 6;
}

message FunctionGetNextOutputRequest {
  string function_id = 1;
  BufferReadRequest buffer_req = 2;
}

message FunctionInput {
  bytes args = 1;
  bytes kwargs = 2;
  string output_buffer_id = 3;
}

message FunctionGetNextInputRequest {
  string function_id = 1;
  string task_id = 4;
  BufferReadRequest buffer_req = 6;
}

message FunctionOutputRequest {
  BufferWriteRequest buffer_req = 8;
  string task_id = 9;
}

message ScheduleCreateRequest {
  string session_id = 1;
  double period = 2;
  bytes args = 3;
  bytes kwargs = 4;
  string cron_string = 5;
}

message ScheduleCreateResponse {
  string schedule_id = 1;
  string error_message = 2;
}

message ScheduleGetPingsRequest {
  string schedule_id = 1;
  float timeout = 2;
  string last_entry_id = 3;
}

message SchedulePing {
  double timestamp = 1;
}

message MountCreateRequest {
  string session_id = 2;
}

message MountCreateResponse {
  string mount_id = 1;
}

message MountRegisterFileRequest {
  string filename = 1;
  string sha256_hex = 2;
  string mount_id = 3;
}

message MountRegisterFileResponse {
  string filename = 1;  // TODO(erikbern): don't think this one is needed?
  bool exists = 2;
}

message MountUploadFileRequest {
  string sha256_hex = 1;
  int32 size = 2;
  bytes data = 3;
  string mount_id = 4;
}

message MountDoneRequest {
  string mount_id = 1;
}

service ModalClient {
  // Clients
  rpc ClientCreate(ClientCreateRequest) returns (ClientCreateResponse);
  rpc ClientHeartbeat(ClientHeartbeatRequest) returns (Empty);

  // Schedules
  rpc ScheduleCreate(ScheduleCreateRequest) returns (ScheduleCreateResponse);
  rpc ScheduleGetPings(ScheduleGetPingsRequest) returns (stream SchedulePing);


  // Sessions
  rpc SessionCreate(SessionCreateRequest) returns (SessionCreateResponse);
  rpc SessionClientDisconnect(SessionClientDisconnectRequest) returns (Empty);
  rpc SessionGetLogs(SessionGetLogsRequest) returns (stream TaskLogsBatch);
  rpc SessionSetObjects(SessionSetObjectsRequest) returns (Empty);
  rpc SessionGetObjects(SessionGetObjectsRequest) returns (SessionGetObjectsResponse);
  rpc SessionIncludeObject(SessionIncludeObjectRequest) returns (SessionIncludeObjectResponse);
  rpc SessionDeploy(SessionDeployRequest) returns (Empty);
  rpc SessionDetach(SessionDetachRequest) returns (Empty);

  // Queues
  rpc QueueCreate(QueueCreateRequest) returns (QueueCreateResponse);
  rpc QueueGet(QueueGetRequest) returns (QueueGetResponse);
  rpc QueuePut(QueuePutRequest) returns (Empty);

  // Mounts
  rpc MountCreate(MountCreateRequest) returns (MountCreateResponse);
  rpc MountRegisterFile(MountRegisterFileRequest) returns (MountRegisterFileResponse);
  rpc MountUploadFile(MountUploadFileRequest) returns (Empty);  // TODO: return something?
  rpc MountDone(MountDoneRequest) returns (Empty);

  // Images
  rpc ImageGetOrCreate(ImageGetOrCreateRequest) returns (ImageGetOrCreateResponse);
  rpc ImageJoin(ImageJoinRequest) returns (ImageJoinResponse);

  // Dicts
  rpc DictCreate(DictCreateRequest) returns (DictCreateResponse);
  rpc DictUpdate(DictUpdateRequest) returns (DictUpdateResponse);
  rpc DictGet(DictGetRequest) returns (DictGetResponse);
  rpc DictPop(DictPopRequest) returns (DictPopResponse);
  rpc DictContains(DictContainsRequest) returns (DictContainsResponse);
  rpc DictLen(DictLenRequest) returns (DictLenResponse);

  // Env Dicts
  rpc EnvDictCreate(EnvDictCreateRequest) returns (EnvDictCreateResponse);

  // Functions
  rpc FunctionCreate(FunctionCreateRequest) returns (FunctionCreateResponse);
  rpc FunctionGetSerialized(FunctionGetSerializedRequest) returns (FunctionGetSerializedResponse);
  rpc FunctionMap(FunctionMapRequest) returns (FunctionMapResponse);
  rpc FunctionCall(FunctionCallRequest) returns (BufferWriteResponse);
  rpc FunctionGetNextOutput(FunctionGetNextOutputRequest) returns (BufferReadResponse);  // Returns the next result
  rpc FunctionGetNextInput(FunctionGetNextInputRequest) returns (BufferReadResponse);  // For containers to request next call
  rpc FunctionOutput(FunctionOutputRequest) returns (BufferWriteResponse);  // For containers to return result
}
